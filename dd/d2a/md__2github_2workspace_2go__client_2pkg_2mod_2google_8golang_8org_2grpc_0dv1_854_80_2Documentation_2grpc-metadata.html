<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: Metadata</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">ResilientDB<span id="projectnumber">&#160;v1.3.1</span>
   </div>
   <div id="projectbrief">NexRes</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/d2a/md__2github_2workspace_2go__client_2pkg_2mod_2google_8golang_8org_2grpc_0dv1_854_80_2Documentation_2grpc-metadata.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Metadata</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md70"></a> gRPC supports sending metadata between client and server. This doc shows how to send and receive metadata in gRPC-go.</p>
<h1><a class="anchor" id="autotoc_md71"></a>
Background</h1>
<p>Four kinds of service method:</p>
<ul>
<li><a href="https://grpc.io/docs/guides/concepts.html#unary-rpc">Unary RPC</a></li>
<li><a href="https://grpc.io/docs/guides/concepts.html#server-streaming-rpc">Server streaming RPC</a></li>
<li><a href="https://grpc.io/docs/guides/concepts.html#client-streaming-rpc">Client streaming RPC</a></li>
<li><a href="https://grpc.io/docs/guides/concepts.html#bidirectional-streaming-rpc">Bidirectional streaming RPC</a></li>
</ul>
<p>And concept of <a href="https://grpc.io/docs/guides/concepts.html#metadata">metadata</a>.</p>
<h1><a class="anchor" id="autotoc_md72"></a>
Constructing metadata</h1>
<p>A metadata can be created using package <a href="https://godoc.org/google.golang.org/grpc/metadata">metadata</a>. The type MD is actually a map from string to a list of strings:</p>
<div class="fragment"><div class="line">type MD map[string][]string</div>
</div><!-- fragment --><p>Metadata can be read like a normal map. Note that the value type of this map is <code>[]string</code>, so that users can attach multiple values using a single key.</p>
<h2><a class="anchor" id="autotoc_md73"></a>
Creating a new metadata</h2>
<p>A metadata can be created from a <code>map[string]string</code> using function <code>New</code>:</p>
<div class="fragment"><div class="line">md := metadata.New(map[string]string{&quot;key1&quot;: &quot;val1&quot;, &quot;key2&quot;: &quot;val2&quot;})</div>
</div><!-- fragment --><p>Another way is to use <code>Pairs</code>. Values with the same key will be merged into a list:</p>
<div class="fragment"><div class="line">md := metadata.Pairs(</div>
<div class="line">    &quot;key1&quot;, &quot;val1&quot;,</div>
<div class="line">    &quot;key1&quot;, &quot;val1-2&quot;, // &quot;key1&quot; will have map value []string{&quot;val1&quot;, &quot;val1-2&quot;}</div>
<div class="line">    &quot;key2&quot;, &quot;val2&quot;,</div>
<div class="line">)</div>
</div><!-- fragment --><p><b>Note:</b> all the keys will be automatically converted to lowercase, so "key1" and "kEy1" will be the same key and their values will be merged into the same list. This happens for both <code>New</code> and <code>Pairs</code>.</p>
<h2><a class="anchor" id="autotoc_md74"></a>
Storing binary data in metadata</h2>
<p>In metadata, keys are always strings. But values can be strings or binary data. To store binary data value in metadata, simply add "-bin" suffix to the key. The values with "-bin" suffixed keys will be encoded when creating the metadata:</p>
<div class="fragment"><div class="line">md := metadata.Pairs(</div>
<div class="line">    &quot;key&quot;, &quot;string value&quot;,</div>
<div class="line">    &quot;key-bin&quot;, string([]byte{96, 102}), // this binary data will be encoded (base64) before sending</div>
<div class="line">                                        // and will be decoded after being transferred.</div>
<div class="line">)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md75"></a>
Retrieving metadata from context</h1>
<p>Metadata can be retrieved from context using <code>FromIncomingContext</code>:</p>
<div class="fragment"><div class="line">func (s *server) SomeRPC(ctx context.Context, in *pb.SomeRequest) (*pb.SomeResponse, err) {</div>
<div class="line">    md, ok := metadata.FromIncomingContext(ctx)</div>
<div class="line">    // do something with metadata</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md76"></a>
Sending and receiving metadata - client side</h1>
<p>Client side metadata sending and receiving examples are available <a href="../../../examples/features/metadata/client/main.go">here</a>.</p>
<h2><a class="anchor" id="autotoc_md77"></a>
Sending metadata</h2>
<p>There are two ways to send metadata to the server. The recommended way is to append kv pairs to the context using <code>AppendToOutgoingContext</code>. This can be used with or without existing metadata on the context. When there is no prior metadata, metadata is added; when metadata already exists on the context, kv pairs are merged in.</p>
<div class="fragment"><div class="line">// create a new context with some metadata</div>
<div class="line">ctx := metadata.AppendToOutgoingContext(ctx, &quot;k1&quot;, &quot;v1&quot;, &quot;k1&quot;, &quot;v2&quot;, &quot;k2&quot;, &quot;v3&quot;)</div>
<div class="line"> </div>
<div class="line">// later, add some more metadata to the context (e.g. in an interceptor)</div>
<div class="line">ctx := metadata.AppendToOutgoingContext(ctx, &quot;k3&quot;, &quot;v4&quot;)</div>
<div class="line"> </div>
<div class="line">// make unary RPC</div>
<div class="line">response, err := client.SomeRPC(ctx, someRequest)</div>
<div class="line"> </div>
<div class="line">// or make streaming RPC</div>
<div class="line">stream, err := client.SomeStreamingRPC(ctx)</div>
</div><!-- fragment --><p>Alternatively, metadata may be attached to the context using <code>NewOutgoingContext</code>. However, this replaces any existing metadata in the context, so care must be taken to preserve the existing metadata if desired. This is slower than using <code>AppendToOutgoingContext</code>. An example of this is below:</p>
<div class="fragment"><div class="line">// create a new context with some metadata</div>
<div class="line">md := metadata.Pairs(&quot;k1&quot;, &quot;v1&quot;, &quot;k1&quot;, &quot;v2&quot;, &quot;k2&quot;, &quot;v3&quot;)</div>
<div class="line">ctx := metadata.NewOutgoingContext(context.Background(), md)</div>
<div class="line"> </div>
<div class="line">// later, add some more metadata to the context (e.g. in an interceptor)</div>
<div class="line">send, _ := metadata.FromOutgoingContext(ctx)</div>
<div class="line">newMD := metadata.Pairs(&quot;k3&quot;, &quot;v3&quot;)</div>
<div class="line">ctx = metadata.NewOutgoingContext(ctx, metadata.Join(send, newMD))</div>
<div class="line"> </div>
<div class="line">// make unary RPC</div>
<div class="line">response, err := client.SomeRPC(ctx, someRequest)</div>
<div class="line"> </div>
<div class="line">// or make streaming RPC</div>
<div class="line">stream, err := client.SomeStreamingRPC(ctx)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md78"></a>
Receiving metadata</h2>
<p>Metadata that a client can receive includes header and trailer.</p>
<h3><a class="anchor" id="autotoc_md79"></a>
Unary call</h3>
<p>Header and trailer sent along with a unary call can be retrieved using function <a href="https://godoc.org/google.golang.org/grpc#Header">Header</a> and <a href="https://godoc.org/google.golang.org/grpc#Trailer">Trailer</a> in <a href="https://godoc.org/google.golang.org/grpc#CallOption">CallOption</a>:</p>
<div class="fragment"><div class="line">var header, trailer metadata.MD // variable to store header and trailer</div>
<div class="line">r, err := client.SomeRPC(</div>
<div class="line">    ctx,</div>
<div class="line">    someRequest,</div>
<div class="line">    grpc.Header(&amp;header),    // will retrieve header</div>
<div class="line">    grpc.Trailer(&amp;trailer),  // will retrieve trailer</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">// do something with header and trailer</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md80"></a>
Streaming call</h3>
<p>For streaming calls including:</p>
<ul>
<li>Server streaming RPC</li>
<li>Client streaming RPC</li>
<li>Bidirectional streaming RPC</li>
</ul>
<p>Header and trailer can be retrieved from the returned stream using function <code>Header</code> and <code>Trailer</code> in interface <a href="https://godoc.org/google.golang.org/grpc#ClientStream">ClientStream</a>:</p>
<div class="fragment"><div class="line">stream, err := client.SomeStreamingRPC(ctx)</div>
<div class="line"> </div>
<div class="line">// retrieve header</div>
<div class="line">header, err := stream.Header()</div>
<div class="line"> </div>
<div class="line">// retrieve trailer</div>
<div class="line">trailer := stream.Trailer()</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md81"></a>
Sending and receiving metadata - server side</h1>
<p>Server side metadata sending and receiving examples are available <a href="../../../examples/features/metadata/server/main.go">here</a>.</p>
<h2><a class="anchor" id="autotoc_md82"></a>
Receiving metadata</h2>
<p>To read metadata sent by the client, the server needs to retrieve it from RPC context. If it is a unary call, the RPC handler's context can be used. For streaming calls, the server needs to get context from the stream.</p>
<h3><a class="anchor" id="autotoc_md83"></a>
Unary call</h3>
<div class="fragment"><div class="line">func (s *server) SomeRPC(ctx context.Context, in *pb.someRequest) (*pb.someResponse, error) {</div>
<div class="line">    md, ok := metadata.FromIncomingContext(ctx)</div>
<div class="line">    // do something with metadata</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md84"></a>
Streaming call</h3>
<div class="fragment"><div class="line">func (s *server) SomeStreamingRPC(stream pb.Service_SomeStreamingRPCServer) error {</div>
<div class="line">    md, ok := metadata.FromIncomingContext(stream.Context()) // get context from stream</div>
<div class="line">    // do something with metadata</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md85"></a>
Sending metadata</h2>
<h3><a class="anchor" id="autotoc_md86"></a>
Unary call</h3>
<p>To send header and trailer to client in unary call, the server can call <a href="https://godoc.org/google.golang.org/grpc#SendHeader">SendHeader</a> and <a href="https://godoc.org/google.golang.org/grpc#SetTrailer">SetTrailer</a> functions in module <a href="https://godoc.org/google.golang.org/grpc">grpc</a>. These two functions take a context as the first parameter. It should be the RPC handler's context or one derived from it:</p>
<div class="fragment"><div class="line">func (s *server) SomeRPC(ctx context.Context, in *pb.someRequest) (*pb.someResponse, error) {</div>
<div class="line">    // create and send header</div>
<div class="line">    header := metadata.Pairs(&quot;header-key&quot;, &quot;val&quot;)</div>
<div class="line">    grpc.SendHeader(ctx, header)</div>
<div class="line">    // create and set trailer</div>
<div class="line">    trailer := metadata.Pairs(&quot;trailer-key&quot;, &quot;val&quot;)</div>
<div class="line">    grpc.SetTrailer(ctx, trailer)</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md87"></a>
Streaming call</h3>
<p>For streaming calls, header and trailer can be sent using function <code>SendHeader</code> and <code>SetTrailer</code> in interface <a href="https://godoc.org/google.golang.org/grpc#ServerStream">ServerStream</a>:</p>
<div class="fragment"><div class="line">func (s *server) SomeStreamingRPC(stream pb.Service_SomeStreamingRPCServer) error {</div>
<div class="line">    // create and send header</div>
<div class="line">    header := metadata.Pairs(&quot;header-key&quot;, &quot;val&quot;)</div>
<div class="line">    stream.SendHeader(header)</div>
<div class="line">    // create and set trailer</div>
<div class="line">    trailer := metadata.Pairs(&quot;trailer-key&quot;, &quot;val&quot;)</div>
<div class="line">    stream.SetTrailer(trailer)</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md88"></a>
Updating metadata from a server interceptor</h1>
<p>An example for updating metadata from a server interceptor is available <a href="../../../examples/features/metadata_interceptor/server/main.go">here</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
